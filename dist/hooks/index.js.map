{"version":3,"sources":["../../src/hooks/use-form-mutation.ts"],"sourcesContent":["/**\n * useFormMutation - Form mutation with auto Laravel error handling\n *\n * Features:\n * - Auto parse Laravel validation errors to Ant Design form format\n * - Support nested field paths (e.g., \"items.0.name\" → [\"items\", 0, \"name\"])\n * - Auto invalidate queries on success\n * - Optional redirect after success\n * - Optional i18n translation for messages\n *\n * @example\n * ```typescript\n * import { useFormMutation } from '@famgia/omnify-react';\n * import { useRouter } from 'next/navigation';\n * import { useTranslations } from 'next-intl';\n *\n * function MyForm() {\n *   const [form] = Form.useForm();\n *   const router = useRouter();\n *   const t = useTranslations();\n *\n *   const mutation = useFormMutation({\n *     form,\n *     mutationFn: (data) => api.post('/api/customers', data),\n *     invalidateKeys: [['customers']],\n *     successMessage: 'messages.saved',\n *     redirectTo: '/customers',\n *     router,           // Optional: for redirect\n *     translateFn: t,   // Optional: for i18n\n *   });\n *\n *   return (\n *     <Form form={form} onFinish={mutation.mutate}>\n *       ...\n *       <Button loading={mutation.isPending}>保存</Button>\n *     </Form>\n *   );\n * }\n * ```\n */\n\nimport { useMutation, useQueryClient } from '@tanstack/react-query';\nimport { App } from 'antd';\nimport type { FormInstance } from 'antd';\n\n// =============================================================================\n// Types\n// =============================================================================\n\n/** Router interface - compatible with Next.js useRouter */\nexport interface FormMutationRouter {\n  push: (path: string) => void;\n}\n\n/** Translation function - compatible with next-intl useTranslations */\nexport type TranslateFn = (key: string) => string;\n\nexport interface UseFormMutationOptions<TData, TResult> {\n  /** Ant Design form instance */\n  form: FormInstance;\n  /** API call function */\n  mutationFn: (data: TData) => Promise<TResult>;\n  /** Query keys to invalidate on success */\n  invalidateKeys?: readonly (readonly unknown[])[];\n  /** Success message to show (will be translated if translateFn provided) */\n  successMessage?: string;\n  /** Redirect path after success (requires router) */\n  redirectTo?: string;\n  /** Router instance for redirect (e.g., useRouter from next/navigation) */\n  router?: FormMutationRouter;\n  /** Translation function for messages (e.g., useTranslations from next-intl) */\n  translateFn?: TranslateFn;\n  /** Callback on success */\n  onSuccess?: (data: TResult) => void;\n  /** Callback on error */\n  onError?: (error: unknown) => void;\n}\n\n// =============================================================================\n// Laravel Error Helpers (exported for reuse)\n// =============================================================================\n\n/** Form field error for Ant Design */\nexport interface FormFieldError {\n  name: string | (string | number)[];\n  errors: string[];\n}\n\n/**\n * Parse Laravel validation errors to Ant Design form format\n *\n * Supports:\n * - Simple fields: \"email\" → name: \"email\"\n * - Dot notation: \"user.name\" → name: [\"user\", \"name\"]\n * - Array notation: \"items.0.name\" → name: [\"items\", 0, \"name\"]\n *\n * @example\n * form.setFields(getFormErrors(error))\n */\nexport function getFormErrors(error: unknown): FormFieldError[] {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const data = (error as any)?.response?.data;\n  const errors = data?.errors;\n\n  if (!errors || typeof errors !== 'object') return [];\n\n  return Object.entries(errors).map(([fieldName, messages]) => ({\n    // Convert \"user.name\" or \"items.0.name\" to array path for Ant Design\n    name: fieldName.includes('.')\n      ? fieldName.split('.').map((part) => (/^\\d+$/.test(part) ? parseInt(part, 10) : part))\n      : fieldName,\n    errors: Array.isArray(messages) ? (messages as string[]) : [String(messages)],\n  }));\n}\n\n/**\n * Get general validation message from Laravel 422 response\n * @example \"The name_lastname field is required. (and 3 more errors)\"\n */\nexport function getValidationMessage(error: unknown): string | null {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const axiosError = error as any;\n\n  // Only for 422 validation errors\n  if (axiosError?.response?.status !== 422) return null;\n\n  return axiosError?.response?.data?.message ?? null;\n}\n\n/**\n * Get first error message from validation errors\n * Useful when field names don't match form fields\n */\nexport function getFirstValidationError(error: unknown): string | null {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const errors = (error as any)?.response?.data?.errors;\n\n  if (!errors || typeof errors !== 'object') return null;\n\n  const firstField = Object.keys(errors)[0];\n  return firstField ? errors[firstField][0] : null;\n}\n\n// =============================================================================\n// Hook\n// =============================================================================\n\nexport function useFormMutation<TData, TResult = unknown>({\n  form,\n  mutationFn,\n  invalidateKeys = [],\n  successMessage,\n  redirectTo,\n  router,\n  translateFn,\n  onSuccess,\n  onError,\n}: UseFormMutationOptions<TData, TResult>) {\n  const queryClient = useQueryClient();\n  const { message } = App.useApp();\n\n  return useMutation({\n    mutationFn,\n    onSuccess: (data) => {\n      // Invalidate queries\n      invalidateKeys.forEach((key) => {\n        queryClient.invalidateQueries({ queryKey: [...key] });\n      });\n\n      // Show success message (translate if translateFn provided)\n      if (successMessage) {\n        const msg = translateFn ? translateFn(successMessage) : successMessage;\n        message.success(msg);\n      }\n\n      // Redirect if router and redirectTo provided\n      if (redirectTo && router) {\n        router.push(redirectTo);\n      }\n\n      // Custom callback\n      onSuccess?.(data);\n    },\n    onError: (error) => {\n      // Set form field errors from Laravel validation\n      const formErrors = getFormErrors(error);\n      if (formErrors.length > 0) {\n        form.setFields(formErrors);\n      }\n\n      // Show general validation message (from Laravel)\n      const validationMessage = getValidationMessage(error);\n      if (validationMessage) {\n        message.error(validationMessage);\n      }\n\n      // Custom callback\n      onError?.(error);\n    },\n  });\n}\n"],"mappings":";AAyCA,SAAS,aAAa,sBAAsB;AAC5C,SAAS,WAAW;AAyDb,SAAS,cAAc,OAAkC;AAE9D,QAAM,OAAQ,OAAe,UAAU;AACvC,QAAM,SAAS,MAAM;AAErB,MAAI,CAAC,UAAU,OAAO,WAAW,SAAU,QAAO,CAAC;AAEnD,SAAO,OAAO,QAAQ,MAAM,EAAE,IAAI,CAAC,CAAC,WAAW,QAAQ,OAAO;AAAA;AAAA,IAE5D,MAAM,UAAU,SAAS,GAAG,IACxB,UAAU,MAAM,GAAG,EAAE,IAAI,CAAC,SAAU,QAAQ,KAAK,IAAI,IAAI,SAAS,MAAM,EAAE,IAAI,IAAK,IACnF;AAAA,IACJ,QAAQ,MAAM,QAAQ,QAAQ,IAAK,WAAwB,CAAC,OAAO,QAAQ,CAAC;AAAA,EAC9E,EAAE;AACJ;AAMO,SAAS,qBAAqB,OAA+B;AAElE,QAAM,aAAa;AAGnB,MAAI,YAAY,UAAU,WAAW,IAAK,QAAO;AAEjD,SAAO,YAAY,UAAU,MAAM,WAAW;AAChD;AAMO,SAAS,wBAAwB,OAA+B;AAErE,QAAM,SAAU,OAAe,UAAU,MAAM;AAE/C,MAAI,CAAC,UAAU,OAAO,WAAW,SAAU,QAAO;AAElD,QAAM,aAAa,OAAO,KAAK,MAAM,EAAE,CAAC;AACxC,SAAO,aAAa,OAAO,UAAU,EAAE,CAAC,IAAI;AAC9C;AAMO,SAAS,gBAA0C;AAAA,EACxD;AAAA,EACA;AAAA,EACA,iBAAiB,CAAC;AAAA,EAClB;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF,GAA2C;AACzC,QAAM,cAAc,eAAe;AACnC,QAAM,EAAE,QAAQ,IAAI,IAAI,OAAO;AAE/B,SAAO,YAAY;AAAA,IACjB;AAAA,IACA,WAAW,CAAC,SAAS;AAEnB,qBAAe,QAAQ,CAAC,QAAQ;AAC9B,oBAAY,kBAAkB,EAAE,UAAU,CAAC,GAAG,GAAG,EAAE,CAAC;AAAA,MACtD,CAAC;AAGD,UAAI,gBAAgB;AAClB,cAAM,MAAM,cAAc,YAAY,cAAc,IAAI;AACxD,gBAAQ,QAAQ,GAAG;AAAA,MACrB;AAGA,UAAI,cAAc,QAAQ;AACxB,eAAO,KAAK,UAAU;AAAA,MACxB;AAGA,kBAAY,IAAI;AAAA,IAClB;AAAA,IACA,SAAS,CAAC,UAAU;AAElB,YAAM,aAAa,cAAc,KAAK;AACtC,UAAI,WAAW,SAAS,GAAG;AACzB,aAAK,UAAU,UAAU;AAAA,MAC3B;AAGA,YAAM,oBAAoB,qBAAqB,KAAK;AACpD,UAAI,mBAAmB;AACrB,gBAAQ,MAAM,iBAAiB;AAAA,MACjC;AAGA,gBAAU,KAAK;AAAA,IACjB;AAAA,EACF,CAAC;AACH;","names":[]}